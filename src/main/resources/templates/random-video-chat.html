<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>랜덤 화상채팅</title>
    <link rel="stylesheet" href="/css/chat-style.css">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
</head>
<body>
    <h1>랜덤 화상채팅</h1>
    <button id="startRandomChat">랜덤 채팅 시작</button>

    <div id="loadingMessage" style="display: none;">
        <p>상대를 검색중입니다...</p>
        <div class="loader"></div> <!-- 로딩 아이콘 -->
    </div>

    <div id="chatControls" style="display: none;">
        <button id="disconnectChat">연결 끊기</button>
        <button id="findAnother">다른 상대 찾기</button>
    </div>

    <div class="container">
        <video id="localVideo" autoplay playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
        <div id="chatBox"></div>
    </div>

    <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
    <button id="sendMessage">전송</button>

    <script>
        // console.log(typeof jwt_decode);
        // console.log("Access Token: " + localStorage.getItem('access_token'));
        // const accessToken = localStorage.getItem('access_token');
        // const decoded = jwt_decode(accessToken);
        // const email = decoded.email;
        // const id = decoded.id;
        // console.log("이메일:", email);
        // console.log("유저 ID:", id);

        let signalingServer;
        let localStream;
        let remoteStream;
        let peerConnection;
        let pendingCandidates = [];
        let offerQueue = [];  // Offer를 대기시키는 큐
        let role = null;

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            const chatControlBox = document.getElementById('chatControls');
            const disconnectButton = document.getElementById('disconnectChat');
            const findAnotherButton = document.getElementById('findAnother');
            const startRandomChatButton = document.getElementById('startRandomChat');
            const loadingMessage = document.getElementById('loadingMessage');

            startRandomChatButton.onclick = function() {
                startRandomChatButton.style.display = 'none';
                loadingMessage.style.display = 'block';
                startVideoChat();
            };

            disconnectButton.onclick = function() {
                disconnectChat();
            };

            findAnotherButton.onclick = function() {
                disconnectChat();
                resetForNewChat();
            };

            function resetForNewChat() {
                chatControlBox.style.display = 'none';
                startRandomChatButton.style.display = 'block';
            }

            function disconnectChat() {
                if (signalingServer) {
                    signalingServer.close();
                    signalingServer = null;
                }
                cleanupVideoChat();
                resetForNewChat();
            }

            function startVideoChat() {
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');


                const signalingServerUrl = 'wss://1.232.89.187:8443/ws/random-video-chat';

                if (signalingServer) {
                    signalingServer.close();  // 기존 연결이 있으면 종료
                    signalingServer = null;
                }

                signalingServer = new WebSocket(signalingServerUrl);
                const chatBox = document.getElementById('chatBox');
                const messageInput = document.getElementById('messageInput');
                const sendMessageButton = document.getElementById('sendMessage');

                signalingServer.onopen = () => {
                    console.log("랜덤채팅 대기열에 추가되었습니다.");
                    signalingServer.send(JSON.stringify({ type: 'random' })); // 대기열에 추가 요청
                };
                initializePeerConnection(localVideo, remoteVideo);
                signalingServer.onmessage = message => {
                    const data = JSON.parse(message.data);
                    switch (data.type) {
                        case 'match':
                            setTimeout(() => {
                                alert(data.message);
                                loadingMessage.style.display = 'none';
                                chatControlBox.style.display = 'block';
                                // 역할 할당 정보 확인
                                role = data.role;
                                if (role === 'offerer') {
                                    createOffer();
                                } else if (role === 'answerer') {
                                    // Offer를 기다림
                                    console.log("Answerer 역할: Offer를 기다립니다.");
                                }
                            }, 2000);
                            break;

                            break;
                        case 'offer':
                            if (role === 'answerer') {
                                handleOffer(data.offer);
                            }
                            break;
                        case 'answer':
                            if (role === 'offerer') {
                                handleAnswer(data.answer);
                            }
                            break;
                        case 'candidate':
                            handleCandidate(data.candidate);
                            break;
                        case 'chat':
                            chatBox.innerHTML += `<div>상대방: ${data.message}</div>`;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            break;
                        case 'system':  // 추가: 퇴장 메시지 처리
                            chatBox.innerHTML += `<div class="system-message">${data.message}</div>`;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            break;
                        case 'waiting': // 추가: 대기 메시지 처리
                            loadingMessage.style.display = 'block';
                            chatControlBox.style.display = 'none';
                            break;
                        default:
                            console.log("알 수 없는 메시지 타입: " + data.type);
                    }
                };

                sendMessageButton.onclick = () => {
                    const message = messageInput.value;
                    if (message) {
                        signalingServer.send(JSON.stringify({ type: 'chat', message: message }));
                        chatBox.innerHTML += `<div>나: ${message}</div>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                        messageInput.value = '';
                    }
                };

                messageInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendMessageButton.click();
                    }
                });
            }

            // function initializePeerConnection(localVideo, remoteVideo) {
            //     // localVideo와 remoteVideo가 정상적으로 전달되었는지 확인
            //     if (!localVideo || !remoteVideo) {
            //         console.error("비디오 요소가 정의되지 않았습니다");
            //         return;
            //     }
            //     navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            //         .then(stream => {
            //             localVideo.srcObject = stream;
            //             localStream = stream;
            //
            //             peerConnection = new RTCPeerConnection(config);
            //             console.log("RTC 연결 생성됨");
            //             // 로컬 비디오 및 오디오 트랙을 추가하여 원격 피어에게 전송
            //             addTracksToPeerConnection(localStream);
            //
            //             // ICE connection state change 이벤트 핸들러 설정
            //             peerConnection.oniceconnectionstatechange = function() {
            //                 console.log("ICE 연결 상태:", peerConnection.iceConnectionState);
            //             };
            //
            //             peerConnection.onicecandidate = event => {
            //                 if (event.candidate) {
            //                     console.log("ICE 후보 발견:", event.candidate);
            //                     signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
            //                 }
            //             };
            //
            //             // 상대방의 트랙이 추가되었을 때 (상대방 화면이 들어옴)
            //             peerConnection.ontrack = event => {
            //                 console.log("상대방 트랙 수신:", event);
            //                 if (!remoteStream) {
            //                     remoteStream = new MediaStream();
            //                     remoteVideo.srcObject = remoteStream;
            //                 }
            //                 remoteStream.addTrack(event.track);
            //                 console.log("상대방 화면 표시 시작");
            //             };
            //
            //             return peerConnection.createOffer();
            //         })
            //         .then(offer => {
            //             return peerConnection.setLocalDescription(offer);
            //         })
            //         .then(() => {
            //             signalingServer.send(JSON.stringify({ type: 'offer', offer: peerConnection.localDescription }));
            //         })
            //         .catch(error => {
            //             console.error("startVideoChat 중 오류:", error);
            //         });
            // }

            function initializePeerConnection(localVideo, remoteVideo) {
                if (!localVideo || !remoteVideo) {
                    console.error("비디오 요소가 정의되지 않았습니다");
                    return Promise.reject("비디오 요소 미정의");
                }

                return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        localVideo.srcObject = stream;
                        localStream = stream;

                        peerConnection = new RTCPeerConnection(config);
                        console.log("RTC 연결 생성됨");
                        addTracksToPeerConnection(localStream);

                        peerConnection.oniceconnectionstatechange = function() {
                            console.log("ICE 연결 상태:", peerConnection.iceConnectionState);
                        };

                        peerConnection.onicecandidate = event => {
                            if (event.candidate) {
                                console.log("ICE 후보 발견:", event.candidate);
                                signalingServer.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                            }
                        };

                        peerConnection.ontrack = event => {
                            console.log("상대방 트랙 수신:", event);
                            if (!remoteStream) {
                                remoteStream = new MediaStream();
                                remoteVideo.srcObject = remoteStream;
                            }
                            remoteStream.addTrack(event.track);
                            console.log("상대방 화면 표시 시작");
                        };
                    })
                    .catch(error => {
                        console.error("getUserMedia 중 오류:", error);
                        return Promise.reject(error);
                    });
            }


            function addTracksToPeerConnection(stream) {
                if (!peerConnection) {
                    console.error("PeerConnection이 초기화되지 않았습니다.");
                    return;
                }
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
            }

            function handleOffer(offer) {
                console.log("Offer 수신: ", offer);
                if (!peerConnection || peerConnection.signalingState !== "stable") {
                    console.warn("Offer를 수신할 수 없는 잘못된 상태입니다. 시그널링 상태:", peerConnection.signalingState);
                    return;
                }

                peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => {
                        console.log("Remote Description 설정 완료");
                        return peerConnection.createAnswer();
                    })
                    .then(answer => {
                        console.log("Answer 생성 완료");
                        return peerConnection.setLocalDescription(answer);
                    })
                    .then(() => {
                        console.log("Local Description 설정 완료");
                        signalingServer.send(JSON.stringify({ type: 'answer', answer: peerConnection.localDescription }));
                    })
                    .then(() => {
                        // 대기 중인 ICE 후보 처리
                        pendingCandidates.forEach(candidate => {
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .catch(error => console.error("대기 중인 ICE 후보 처리 중 오류:", error));
                        });
                        pendingCandidates = [];
                    })
                    .catch(error => console.error("Offer 처리 중 오류: ", error));
            }


            function handleAnswer(answer) {
                console.log("Answer 수신: ", answer);
                if (peerConnection.signalingState !== "have-local-offer") {
                    console.warn("잘못된 상태에서 answer가 수신되었습니다.");
                    return;
                }
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                    .catch(error => console.error("Answer 처리 중 오류:", error));
            }

            function handleCandidate(candidate) {
                if (!peerConnection || !peerConnection.remoteDescription) {
                    console.warn("원격 설명이 설정되지 않아 ICE 후보를 대기합니다.");
                    pendingCandidates.push(candidate);
                    return;
                }
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .catch(error => console.error("ICE 후보 처리 중 오류:", error));
            }

            function createOffer() {
                if (!peerConnection) {
                    console.error("PeerConnection이 초기화되지 않았습니다.");
                    return;
                }
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        signalingServer.send(JSON.stringify({ type: 'offer', offer: peerConnection.localDescription }));
                    })
                    .catch(error => {
                        console.error("Offer 생성 중 오류:", error);
                    });
            }


            function cleanupVideoChat() {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                remoteStream = null;
                pendingCandidates = [];
                role = null;
            }


        });
    </script>
</body>
</html>